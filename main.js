// LINE ã¸ã®æ¥ç¶šã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚
var line_endpoint = 'https://api.line.me/v2/bot/message/reply';
var line_endpoint_profile = 'https://api.line.me/v2/bot/profile';


function doPost(e) {
// ä¸€èˆ¬çš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®mainé–¢æ•°éƒ¨åˆ†ã«ã‚ãŸã‚‹ã€‚ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚„ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å†…åŒ…ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•° eã¨ã—ã¦å—ã‘å–ã‚‹ã€‚
  
  // ã“ã“ã‹ã‚‰ã€å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ eã‚’åŠ å·¥ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–ã‚Šå‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‡¦ç†ã€‚
  var json = JSON.parse(e.postData.contents);  
  var reply_token= json.events[0].replyToken;  
  var contents = e.postData.contents;
  var obj = JSON.parse(contents);
  var events = obj["events"];
  //ã“ã“ã¾ã§
    
  var user_id = json.events[0].source.userId; // LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã—ã¦æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚
  var user_message = json.events[0].message.text; // å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚  
  var user_messageParameter = user_message.split(/\s|\r\n|\n/); // å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹è¡Œã§åˆ†å‰²ã—ã¦é…åˆ—ã¨ã—ã¦æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚
  
  var reply_messages; // é€ä¿¡å†…å®¹ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚
  
  var spreadSheet = getSpreadSheet(user_id); // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚‚ã¨ã«å€‹ã€…äººã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ»ãƒ–ãƒƒã‚¯è­˜åˆ¥å­ã‚’å–å¾—ã—ã€æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚
  Utilities.sleep(500); // ä¸Šè¨˜å‡¦ç†ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€ã‚ã–ã¨500ãƒŸãƒªç§’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä¸€æ™‚åœæ­¢ã•ã›ã‚‹ã€‚
  
  var sheet = spreadSheet.getSheets()[0]; // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ»ãƒ–ãƒƒã‚¯ã®æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—ã—ã€æ ¼ç´ã™ã‚‹å¤‰æ•°ã€‚
    
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®šç¾©ã€‚ä¸€å®šæ™‚é–“ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒçµ‚äº†ã•ã‚Œã¦ã‚‚å¤‰æ•°ãŒç ´æ£„ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
  var cache = CacheService.getScriptCache();
  var type = cache.get("type"); // Switch æ–‡ã§ã®åˆ†å²ç”¨ã®å¤‰æ•°ã€‚
  var temp = cache.get("temp"); // ä½“æ¸©ã®å¤‰æ•°ã€‚
  var cond = cache.get("cond"); // ä½“èª¿ã«é–¢ã™ã‚‹å¤‰æ•°ã€‚
  var travel = cache.get("travel"); // 2é€±é–“ä»¥å†…ã®çœŒå¤–ã¸ã®ç§»å‹•æ­´ã«é–¢ã™ã‚‹å¤‰æ•°ã€‚
  
  
  //ä»¥ä¸‹ã€é€ä¿¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã®å†…å®¹ã«ã‚ˆã£ã¦å‡¦ç†ã‚’å¤‰ãˆã‚‹ã€‚
  //è¨˜éŒ²ãƒ»å‰Šé™¤ãªã©ã®å‡¦ç†ã®æœ€å¾Œã«ã¯ã€å¿…ãšdeleteAllCacheé–¢æ•°ã‚’ä½¿ã£ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å†…å®¹ã‚’ç ´æ£„ã™ã‚‹ã€‚

  if ('è¨˜éŒ²' == user_messageParameter[0]) { //ã€Œè¨˜éŒ²ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã€ä½“æ¸©ãƒ»ä½“èª¿ãªã©ã®è¨˜éŒ²ã‚’é–‹å§‹ã™ã‚‹ã€‚ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä½“æ¸©ã®å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
    cache.put("type", 1); // Switchæ–‡ã®case 1ã«å‡¦ç†ã‚’ç§»ã™ã€‚
    reply_messages = ["è¨˜éŒ²ã‚’é–‹å§‹ã—ã¾ã™ã€‚\nå…¥åŠ›ã‚’é–“é•ãˆãŸå ´åˆã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§è¨˜éŒ²ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„\n\nã¯ã˜ã‚ã«ã€ä½“æ¸©ã‚’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„(ä¾‹:35):"];
  } else if ('å‰Šé™¤' == user_messageParameter[0]) {ã€€//ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã€å‰Šé™¤ã—ãŸã„è¨˜éŒ²ã®è¡Œã‚’é¸æŠã•ã›ã‚‹ã€‚ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡Œç•ªå·ã®å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
    cache.put("type", 5);ã€€// Switchæ–‡ã®case 5ã«å‡¦ç†ã‚’ç§»ã™ã€‚
    reply_messages = ["æ¤œç´¢ã§è¡¨ç¤ºã•ã‚ŒãŸè¡¨ã‹ã‚‰ã€å‰Šé™¤ã—ãŸã„è¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§æ“ä½œã‚’å–ã‚Šæ¶ˆã›ã¾ã™ã€‚\n\nå…¥åŠ›ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™..."];
  } else if ('æ¤œç´¢' == user_messageParameter[0]) { //ã€Œæ¤œç´¢ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã€å…¥åŠ›å†…å®¹ã‚’ä¸€è¦§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
    reply_messages = [spreadSheet.getUrl()];
    deleteAllCache(cache);        
  } else if ('ã‚°ãƒ©ãƒ•' == user_messageParameter[0]) { //ã€Œè¨˜éŒ²ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã€sendGraphé–¢æ•°ã¨sendImageé–¢æ•°ã‚’ä½¿ã£ã¦ç›´è¿‘æ•°æ—¥é–“ã®ä½“æ¸©ã®ã‚°ãƒ©ãƒ•ã‚’é€ä¿¡ã™ã‚‹ã€‚
    //sendGraph(sheet,user_id);
    //deleteAllCache(cache);
    reply_messages = ["èª¿æ•´ä¸­ã§ã™ğŸ™‡â€â™‚ï¸"];
  }else if ('ã‚­ãƒ£ãƒ³ã‚»ãƒ«' == user_messageParameter[0]){  //ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã€ç›´ã¡ã«ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„ã—ã¦ä»Šå¾Œã®å‹•ä½œã«æ”¯éšœã‚’ããŸã•ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
    reply_messages = [ "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"];
    cache.put("type", 7); // Switchæ–‡ã®case 7ã«å‡¦ç†ã‚’ç§»ã™ã€‚
  }else{
    
    switch (type) {
      case "1":
        cache.put("temp", user_messageParameter[0]);//å…¥åŠ›ã•ã‚ŒãŸä½“æ¸©ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ tempã«æ ¼ç´ã€‚
        cache.put("type", 2);// Switchæ–‡ã®case 2ã«å‡¦ç†ã‚’ç§»ã™ã€‚
        question(events[0],"ä½“ã«ç•°å¸¸ãŒã‚ã‚Œã°ç—‡çŠ¶ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„\nç‰¹ã«ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");ã€€// nostatusã€€é–¢æ•°ã‚’ä½¿ã£ã¦ã€ä½“èª¿ã«é–¢ã™ã‚‹è³ªå•ã‚’ã—ã€å›ç­”ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
        break;
      case "2":
        cache.put("cond", user_messageParameter[0]);//å…¥åŠ›ã•ã‚ŒãŸã€ä½“èª¿ã«ã¤ã„ã¦ã®æ–‡å­—åˆ—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ tempã«æ ¼ç´ã€‚
        cache.put("type", 3);// Switchæ–‡ã®case 3ã«å‡¦ç†ã‚’ç§»ã™ã€‚
        question(events[0],"2é€±é–“ä»¥å†…ã®çœŒå¤–ã¸ã®ç§»å‹•æ­´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nç‰¹ã«ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");// notravelã€€é–¢æ•°ã‚’ä½¿ã£ã¦ã€2é€±é–“ä»¥å†…ã®çœŒå¤–æ¸¡èˆªå…ˆã«é–¢ã™ã‚‹è³ªå•ã‚’ã—ã€å›ç­”ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
        break;
      case "3":
        cache.put("travel", user_messageParameter[0]);//å…¥åŠ›ã•ã‚ŒãŸã€2é€±é–“ä»¥å†…ã®çœŒå¤–æ¸¡èˆªå…ˆã«ã¤ã„ã¦ã®æ–‡å­—åˆ—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ tempã«æ ¼ç´ã€‚
        cache.put("type", 4);// Switchæ–‡ã®case 4ã«å‡¦ç†ã‚’ç§»ã™ã€‚
        yesorno(events[0]);// yesornoã€€é–¢æ•°ã‚’ä½¿ã£ã¦ã€ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ç¢ºå®šã™ã‚‹ã‹å›ç­”ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
        break;
      case "4":
        if ("ã¯ã„"== user_messageParameter[0]) { //case 3ã«ãŠã„ã¦"ã¯ã„"ã¨ã„ã†æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
          addToSpreadsheet(temp,cond,travel,sheet); //ä½“æ¸©ã€ä½“èª¿ã€çœŒå¤–æ¸¡èˆªå…ˆã‚’ã€addToSpreadsheet é–¢æ•°ã‚’ä½¿ã£ã¦sheetãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã€‚
          if(temp>=37 || cond != "ç‰¹ã«ãªã—" || travel != "ç‰¹ã«ãªã—")
          //ä½“æ¸©ãŒ37åº¦ä»¥ä¸Šã€ä½“èª¿ã¨çœŒå¤–æ¸¡èˆªå…ˆãŒ"ç‰¹ã«ãªã—"ã§ãªã‹ã£ãŸå ´åˆ
          //(ç•°å¸¸ãŒç‰¹ã«ãªã„å ´åˆã¯ã€Œç‰¹ã«ãªã—ã€ãƒœã‚¿ãƒ³ã§ç°¡å˜ã«å…¥åŠ›ã§ãã‚‹ã€‚nostatus,notravelé–¢æ•°å‚ç…§)ã€
          //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰åŒ–ã•ã›ã‚‹ã€‚
          {
            reply_messages = ["è¨˜å¸³ã—ã¾ã—ãŸã€‚\nã‚³ãƒ­ãƒŠã‚¦ã‚¤ãƒ«ã‚¹ã¸ã®æ„ŸæŸ“ã‚’ç‰¹ã«è­¦æˆ’ã—ã€\näººã¨ã®æ¥è§¦ã«æ°—ã‚’ä»˜ã‘ã¤ã¤ã€ãŠå¤§äº‹ã«ãªã•ã£ã¦ãã ã•ã„ã€‚"];
          }else{
          reply_messages = [ "è¨˜å¸³ã—ã¾ã—ãŸã€‚"];
          }
          deleteAllCache(cache);
        } else { //case 3ã«ãŠã„ã¦"ã„ã„ãˆ"ã¨ã„ã†æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã‚‚å«ã‚ã€"ã¯ã„"ä»¥å¤–ã§ã‚ã‚Œã°ã€è¨˜éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã¨ã¿ãªã™ã€‚
          reply_messages = [ "å—ä»˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"];
          deleteAllCache(cache);
        }
        break;
      
      case "5":
        // äºˆå®š
        cache.put("temp", user_messageParameter[0]); //å…¥åŠ›ã•ã‚ŒãŸã€è¡Œç•ªå·ã‚’ç¤ºã™æ•°å€¤ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ tempã«æ ¼ç´ã€‚
        cache.put("type", 6);// Switchæ–‡ã®case 6ã«å‡¦ç†ã‚’ç§»ã™ã€‚
        yesorno(events[0]);// yesornoã€€é–¢æ•°ã‚’ä½¿ã£ã¦ã€ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ç¢ºå®šã™ã‚‹ã‹å›ç­”ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
        break;
      case "6":
        //case 5ã«ãŠã„ã¦"ã¯ã„"ã¨ã„ã†æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
        if ("ã¯ã„"== user_messageParameter[0]) {         
          reply_messages = ["å—ä»˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"];
          deleteInSpreadSheet(sheet,temp); //deleteInSpreadsheet é–¢æ•°ã‚’ä½¿ã£ã¦sheetãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã‹ã‚‰ã€æŒ‡å®šã•ã‚ŒãŸè¡Œç•ªå·ã®è¡Œã®å†…å®¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚
        }else { //case 5ã«ãŠã„ã¦"ã„ã„ãˆ"ã¨ã„ã†æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã‚‚å«ã‚ã€"ã¯ã„"ä»¥å¤–ã§ã‚ã‚Œã°ã€è¨˜éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã¨ã¿ãªã™ã€‚
          reply_messages = ["å—ä»˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"];
        }
        deleteAllCache(cache);
        break;
        
      case "7"://ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¨å…¥åŠ›ã•ã‚ŒãŸå ´åˆã‹ã‚‰ã®åˆ†å²ã€‚
        deleteAllCache(cache);
        break;
      
      default: //"è¨˜éŒ²","æ¤œç´¢", "ã‚°ãƒ©ãƒ•", "å‰Šé™¤" ä»¥å¤–ã®æ–‡å­—åˆ—ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ
        reply_messages = [ "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚\nç”»é¢ä¸‹éƒ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚"];
        deleteAllCache(cache);
        break;
    }   
  }
  
  // reply_messages=["æ–‡å­—åˆ—"]ã¨ã„ã†å½¢å¼ã§é€ä¿¡ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã€ãã®å†…å®¹ã‚’å–å¾—ã™ã‚‹ã€‚
  var messages = reply_messages.map(function (v) {
    return {'type': 'text', 'text': v};    
  });     
  // ä»¥ä¸‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ã®LINE APIã®è¨­å®šã€‚
  UrlFetchApp.fetch(line_endpoint, {
    'headers': {
      'Content-Type': 'application/json; charset=UTF-8',
      'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN,
    },
    'method': 'post',
    'payload': JSON.stringify({
      'replyToken': reply_token,
      'messages': messages,
    }),
  });
  return ContentService.createTextOutput(JSON.stringify({'content': 'post ok'})).setMimeType(ContentService.MimeType.JSON);
}
